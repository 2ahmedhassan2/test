<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>كويز Google Sheets</title>

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body { font-family: "Segoe UI", Tahoma, Arial, sans-serif; background:#f4f6fb; padding:20px; direction:rtl; }
    .card-quiz { max-width: 1000px; margin: 0 auto 20px; }
    .option-letter { font-weight:700; width:26px; display:inline-block; text-align:center; }
    .option-text { display:inline-block; }
    .result-card.correct { border: 2px solid #198754; background: #ecf9f0; }
    .result-card.wrong { border: 2px solid #dc3545; background: #fff0f0; }
    .badge-correct { background:#198754; color:#fff; }
    .badge-wrong { background:#dc3545; color:#fff; }
    .muted-sm { color:#6c757d; font-size:0.9rem; }
    /* small responsive tweaks */
    @media (max-width:575.98px) {
      .option-letter { width:20px; font-size:0.85rem; }
    }
  </style>
</head>

<body>
  <div class="container">

    <div class="card card-quiz mb-4 shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <div>
            <h3 class="card-title mb-0">الاختبار</h3>
            <div class="muted-sm">اختر الإجابة الصحيحة ثم اضغط إرسال</div>
          </div>
          <div>
            <button id="refreshBtn" class="btn btn-outline-secondary btn-sm" onclick="loadQuestions()">تحديث</button>
          </div>
        </div>

        <div id="status" class="muted-sm mb-2">جارٍ تحميل الأسئلة ...</div>

        <form id="quizForm" hidden></form>

        <div class="d-flex gap-2 mt-3">
          <button id="submitBtn" class="btn btn-primary" type="button" onclick="checkAnswers()" hidden>إرسال</button>
          <button id="clearResultsBtn" class="btn btn-outline-secondary" type="button" onclick="clearResults()" hidden>مسح النتائج</button>
        </div>

        <div id="resultSummary" class="mt-3"></div>
      </div>
    </div>

    <!-- Result area: per-question cards -->
    <div id="resultsArea" class="mb-4"></div>

    <!-- Add question card -->
    <div class="card card-quiz shadow-sm mb-5">
      <div class="card-body">
        <h4 class="card-title">إضافة سؤال جديد</h4>
        <div class="muted-sm mb-3">أدخل كل اختيار في حقل منفصل. اختر الإجابة الصحيحة من القائمة.</div>

        <form id="addForm" onsubmit="addQuestion(event)">
          <div class="mb-3">
            <label class="form-label">نص السؤال</label>
            <input type="text" id="qText" class="form-control" placeholder="اكتب السؤال هنا" required>
          </div>

          <div id="optionsWrapper" class="mb-2">
            <label class="form-label">الاختيارات</label>
            <!-- option inputs inserted here -->
          </div>

          <div class="mb-2 d-flex gap-2">
            <button type="button" class="btn btn-outline-primary btn-sm" onclick="addOption()">+ إضافة اختيار</button>
            <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeOption()">ـ إزالة اختيار</button>
          </div>

          <div class="mb-3">
            <label class="form-label">الإجابة الصحيحة</label>
            <select id="qAnswer" class="form-select" required>
              <option value="">اختر الإجابة الصحيحة</option>
            </select>
          </div>

          <div class="d-flex gap-2 align-items-center">
            <button type="submit" class="btn btn-success">إضافة السؤال</button>
            <div id="addStatus" class="muted-sm"></div>
          </div>
        </form>
      </div>
    </div>

  </div>

  <!-- Bootstrap 5 JS bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ====== CONFIGURE: put your Web App URL here ======
    const API_URL = "https://script.google.com/macros/s/AKfycbwcPf8qGqwZ3dBGQRnn-_MXsqJMTiPgF3ajSrdGFeTxc9B2VAkvaC9HU0WnpfTEfUwU/exec";

    // helpers
    const $ = sel => document.querySelector(sel);
    const create = (tag, attrs = {}) => {
      const el = document.createElement(tag);
      for (const k in attrs) {
        if (k === "text") el.textContent = attrs[k];
        else el.setAttribute(k, attrs[k]);
      }
      return el;
    };

    // dynamic option inputs for Add form
    const optionsWrapper = document.getElementById('optionsWrapper');
    const answerSelect = document.getElementById('qAnswer');

    function addOption(value = '') {
      const idx = optionsWrapper.querySelectorAll('.option-row').length;
      const row = create('div', { 'class': 'input-group mb-2 option-row' });
      row.innerHTML = `
        <span class="input-group-text option-letter">${String.fromCharCode(65 + idx) /* A,B,C... */}</span>
        <input class="form-control option-input" type="text" placeholder="نص الاختيار" value="${(value||'').replace(/"/g,'&quot;')}" required/>
      `;
      optionsWrapper.appendChild(row);
      updateAnswerOptions();
      return row;
    }

    function removeOption() {
      const rows = optionsWrapper.querySelectorAll('.option-row');
      if (rows.length <= 1) return;
      rows[rows.length - 1].remove();
      // update letters
      optionsWrapper.querySelectorAll('.option-row').forEach((r, i) => {
        const s = r.querySelector('.input-group-text');
        if (s) s.textContent = String.fromCharCode(65 + i);
      });
      updateAnswerOptions();
    }

    function updateAnswerOptions() {
      const opts = Array.from(optionsWrapper.querySelectorAll('.option-input')).map(i => i.value.trim()).filter(Boolean);
      answerSelect.innerHTML = '<option value="">اختر الإجابة الصحيحة</option>';
      opts.forEach(o => {
        const opt = create('option');
        opt.value = o;
        opt.textContent = o;
        answerSelect.appendChild(opt);
      });
    }

    // initialize 4 option inputs
    addOption(''); addOption(''); addOption(''); addOption('');

    // update answer select on typing
    optionsWrapper.addEventListener('input', (e) => {
      if (e.target.classList.contains('option-input')) updateAnswerOptions();
    });

    // ----- Fetch & Render Quiz -----
    let questions = [];

    async function loadQuestions() {
      $('#status').textContent = 'جارٍ تحميل الأسئلة ...';
      $('#resultSummary').innerHTML = '';
      $('#resultsArea').innerHTML = '';
      try {
        const res = await fetch(API_URL);
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        if (!Array.isArray(data)) throw new Error('بيانات غير متوقعة من الخادم');
        questions = data;
        renderQuiz();
        $('#status').textContent = '';
      } catch (err) {
        console.error(err);
        $('#status').innerHTML = `<span class="text-danger">فشل في تحميل الأسئلة.</span> ${err.message}`;
        // hide buttons
        $('#submitBtn').hidden = true;
        $('#clearResultsBtn').hidden = true;
      }
    }

    function renderQuiz() {
      const form = $('#quizForm');
      form.innerHTML = '';
      if (!questions.length) {
        form.innerHTML = '<p class="muted-sm">لا توجد أسئلة حالياً.</p>';
        $('#submitBtn').hidden = true;
        $('#quizForm').hidden = false;
        return;
      }

      questions.forEach((q, i) => {
        const div = create('div', { 'class': 'question mb-3' });
        const title = create('div', { 'class': 'mb-2' });
        title.innerHTML = `<strong>${i+1}.</strong> ${escapeHtml(q.question)}`;
        div.appendChild(title);

        // options list
        const list = create('div', { 'class': 'list-group' });
        if (Array.isArray(q.options)) {
          q.options.forEach((opt, j) => {
            const letter = String.fromCharCode(65 + j);
            const label = create('label', { 'class': 'list-group-item d-flex align-items-center' });
            label.innerHTML = `
              <input class="form-check-input me-2" type="radio" name="q${i}" value="${escapeAttr(opt)}" style="margin-left:10px;">
              <span class="option-letter">${letter}</span>
              <span class="option-text ms-2">${escapeHtml(opt)}</span>
            `;
            list.appendChild(label);
          });
        }
        div.appendChild(list);
        form.appendChild(div);
      });

      $('#submitBtn').hidden = false;
      $('#clearResultsBtn').hidden = true;
      $('#quizForm').hidden = false;
      // clear results area
      $('#resultsArea').innerHTML = '';
      $('#resultSummary').innerHTML = '';
    }

    // ----- Check answers and show detailed results -----
    function checkAnswers() {
      if (!questions.length) return;
      let score = 0;
      const resultsArea = $('#resultsArea');
      resultsArea.innerHTML = '';

      questions.forEach((q, i) => {
        const selectedInput = document.querySelector(`input[name="q${i}"]:checked`);
        const selectedValue = selectedInput ? selectedInput.value.trim() : null;
        const correctValue = (q.answer || '').trim();
        const isCorrect = selectedValue && (selectedValue === correctValue);
        if (isCorrect) score++;

        // result card
        const card = create('div', { 'class': 'card mb-3 result-card ' + (isCorrect ? 'correct' : 'wrong') });
        const body = create('div', { 'class': 'card-body' });
        body.innerHTML = `<h5 class="card-title mb-1">${i+1}. ${escapeHtml(q.question)}</h5>
                          <div class="muted-sm mb-2">إجابتك: ${selectedValue ? escapeHtml(selectedValue) : '<span class="text-muted">لم تختر إجابة</span>'}</div>`;

        // options list with highlights
        const ul = create('div', { 'class': 'list-group' });
        if (Array.isArray(q.options)) {
          q.options.forEach((opt, j) => {
            const letter = String.fromCharCode(65 + j);
            const item = create('div', { 'class': 'list-group-item d-flex justify-content-between align-items-center' });
            item.innerHTML = `<div><span class="option-letter">${letter}</span> <span class="option-text">${escapeHtml(opt)}</span></div>`;
            // highlight correct/wrong
            if (opt === correctValue) {
              // correct option - green badge
              const badge = create('span', { 'class': 'badge badge-correct' });
              badge.classList.add('badge', 'rounded-pill');
              badge.textContent = 'الإجابة الصحيحة';
              item.appendChild(badge);
              item.style.fontWeight = '600';
            }
            if (selectedValue && selectedValue === opt && selectedValue !== correctValue) {
              // user selected this but it's wrong
              const badge = create('span', { 'class': 'badge badge-wrong' });
              badge.classList.add('badge', 'rounded-pill');
              badge.textContent = 'خطأ';
              item.appendChild(badge);
              item.style.textDecoration = 'line-through';
            }
            // also mark selected correct with check icon
            if (selectedValue && selectedValue === opt && selectedValue === correctValue) {
              const badge = create('span', { 'class': 'badge badge-correct' });
              badge.classList.add('badge', 'rounded-pill');
              badge.textContent = 'تم اختيارها';
              item.appendChild(badge);
            }
            ul.appendChild(item);
          });
        }

        body.appendChild(ul);
        card.appendChild(body);
        resultsArea.appendChild(card);
      });

      // summary
      $('#resultSummary').innerHTML = `<div class="alert ${score === questions.length ? 'alert-success' : (score === 0 ? 'alert-danger' : 'alert-info')}">
        <strong>درجتك: ${score} من ${questions.length}</strong>
        </div>`;

      // after showing results: disable inputs and hide submit
      document.querySelectorAll('#quizForm input[type="radio"]').forEach(r => r.disabled = true);
      $('#submitBtn').hidden = true;
      $('#clearResultsBtn').hidden = false;
      // scroll to results
      setTimeout(() => {
        document.getElementById('resultsArea').scrollIntoView({ behavior: 'smooth' });
      }, 100);
    }

    function clearResults() {
      // re-enable radios, clear selections
      document.querySelectorAll('#quizForm input[type="radio"]').forEach(r => {
        r.disabled = false;
        r.checked = false;
      });
      $('#resultsArea').innerHTML = '';
      $('#resultSummary').innerHTML = '';
      $('#submitBtn').hidden = false;
      $('#clearResultsBtn').hidden = true;
      // scroll to top of quiz
      document.getElementById('quizForm').scrollIntoView({ behavior: 'smooth' });
    }

    // ----- Add question (POST) -----
    async function addQuestion(e) {
      e.preventDefault();
      const addStatus = $('#addStatus');
      const qText = $('#qText').value.trim();
      const opts = Array.from(document.querySelectorAll('.option-input')).map(i => i.value.trim()).filter(Boolean);
      const qAnswer = $('#qAnswer').value.trim();

      if (!qText) { alert('أدخل نص السؤال'); return; }
      if (opts.length < 2) { alert('أدخل على الأقل خيارين'); return; }
      if (!opts.includes(qAnswer)) { alert('يجب أن تكون الإجابة الصحيحة إحدى الخيارات'); return; }

      addStatus.textContent = 'جاري الإرسال...';
      try {
        const payload = new URLSearchParams();
        payload.append('question', qText);
        payload.append('options', JSON.stringify(opts));
        payload.append('answer', qAnswer);

        const res = await fetch(API_URL, { method: 'POST', body: payload });
        const text = await res.text();
        // try parse response
        try {
          const j = JSON.parse(text);
          if (j.ok === false) throw new Error(j.error || 'server error');
        } catch (err) {
          // ignore if not JSON
        }

        addStatus.textContent = 'تمت إضافة السؤال!';
        // reset form
        document.getElementById('addForm').reset();
        optionsWrapper.innerHTML = '';
        addOption(''); addOption(''); addOption(''); addOption('');
        updateAnswerOptions();
        // reload the questions to include newly added item
        loadQuestions();
        setTimeout(() => addStatus.textContent = '', 2500);
      } catch (err) {
        console.error(err);
        addStatus.textContent = 'فشل في الإرسال.';
        alert('خطأ أثناء الإرسال: ' + err.message);
      }
    }

    // small helpers to escape HTML / attributes
    function escapeHtml(s) { return String(s || '').replace(/[&<>"']/g, m => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
    function escapeAttr(s) { return String(s || '').replace(/"/g, '&quot;'); }

    // start
    loadQuestions();

  </script>
</body>
</html>
