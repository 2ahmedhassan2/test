<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>كويز Google Sheets</title>
  <style>
    body { font-family: Arial, sans-serif; padding:20px; direction:rtl; }
    .card{ border:1px solid #ddd; padding:12px; border-radius:8px; background:#fff; max-width:900px; }
    .question{ margin-bottom:12px; padding:10px; border-radius:6px; border:1px solid #eee; }
    .row{ display:flex; gap:8px; align-items:center; margin-bottom:8px; }
    input[type=text]{ padding:8px; width:100%; box-sizing:border-box; }
    button{ padding:8px 12px; border-radius:6px; cursor:pointer; }
    .muted{ color:#666; font-size:0.9rem; }
  </style>
</head>
<body>
  <h2>الاختبار</h2>
  <div class="card">
    <div id="status" class="muted">جارٍ تحميل الأسئلة ...</div>
    <form id="quizForm" hidden></form>
    <button id="submitBtn" type="button" onclick="checkAnswers()" hidden>إرسال</button>
    <div id="result" style="margin-top:12px;font-weight:700"></div>
  </div>

  <hr style="margin:20px 0">

  <h3>إضافة سؤال جديد</h3>
  <div class="card">
    <form id="addForm" onsubmit="addQuestion(event)">
      <div style="margin-bottom:8px">
        <label class="muted">نص السؤال</label>
        <input type="text" id="qText" required placeholder="اكتب السؤال هنا">
      </div>

      <div id="optionsWrapper">
        <label class="muted">الاختيارات</label>
        <!-- option inputs will be inserted here -->
      </div>

      <div style="margin-top:8px; display:flex; gap:8px;">
        <button type="button" onclick="addOption()">+ إضافة اختيار</button>
        <button type="button" onclick="removeOption()">ـ إزالة اختيار</button>
      </div>

      <div style="margin-top:10px">
        <label class="muted">الإجابة الصحيحة</label>
        <select id="qAnswer" required>
          <option value="">اختر الإجابة الصحيحة</option>
        </select>
      </div>

      <div style="margin-top:12px">
        <button type="submit">إضافة السؤال</button>
        <span id="addStatus" class="muted"></span>
      </div>
    </form>
  </div>

  <script>
    // <-- PASTE your Web App URL here:
    const API_URL = "https://script.google.com/macros/s/AKfycbwcPf8qGqwZ3dBGQRnn-_MXsqJMTiPgF3ajSrdGFeTxc9B2VAkvaC9HU0WnpfTEfUwU/exec";

    // Helpers
    const $ = sel => document.querySelector(sel);
    const create = (tag, attrs={}) => {
      const el = document.createElement(tag);
      for (const k in attrs) {
        if (k === 'text') el.textContent = attrs[k];
        else el.setAttribute(k, attrs[k]);
      }
      return el;
    };

    // manage dynamic option inputs
    const optionsWrapper = document.getElementById('optionsWrapper');
    const answerSelect = document.getElementById('qAnswer');

    function addOption(value = '') {
      const idx = optionsWrapper.querySelectorAll('.option-row').length;
      const row = create('div');
      row.className = 'row option-row';
      row.innerHTML = `
        <input class="option-input" type="text" placeholder="نص الاختيار" value="${value.replace(/"/g,'&quot;')}" required/>
      `;
      optionsWrapper.appendChild(row);
      updateAnswerOptions();
      return row;
    }

    function removeOption() {
      const rows = optionsWrapper.querySelectorAll('.option-row');
      if (rows.length <= 1) return;
      rows[rows.length - 1].remove();
      updateAnswerOptions();
    }

    function updateAnswerOptions() {
      // collect option texts
      const opts = Array.from(optionsWrapper.querySelectorAll('.option-input')).map(i => i.value.trim()).filter(Boolean);
      // rebuild answer select
      answerSelect.innerHTML = '<option value="">اختر الإجابة الصحيحة</option>';
      opts.forEach(o => {
        const opt = document.createElement('option');
        opt.value = o;
        opt.textContent = o;
        answerSelect.appendChild(opt);
      });
    }

    // start with 4 option inputs
    addOption(''); addOption(''); addOption(''); addOption('');

    // update answer select whenever option inputs change
    optionsWrapper.addEventListener('input', (e) => {
      if (e.target.classList.contains('option-input')) updateAnswerOptions();
    });

    // ---- Fetch & Render Questions ----
    let questions = [];

    async function loadQuestions(){
      $('#status').textContent = 'جارٍ تحميل الأسئلة ...';
      try {
        const res = await fetch(API_URL);
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        if (!Array.isArray(data)) throw new Error('البيانات ليست مصفوفة');
        questions = data;
        renderQuiz();
        $('#status').textContent = '';
      } catch (err) {
        console.error(err);
        $('#status').innerHTML = '<span style="color:red">فشل في تحميل الأسئلة.</span> ' + err.message;
      }
    }

    function renderQuiz(){
      const form = $('#quizForm');
      form.innerHTML = '';
      if (!questions.length) {
        form.innerHTML = '<p class="muted">لا توجد أسئلة حالياً.</p>';
        $('#submitBtn').hidden = true;
        $('#quizForm').hidden = false;
        return;
      }
      questions.forEach((q, i) => {
        const div = document.createElement('div');
        div.className = 'question';
        div.innerHTML = `<p><strong>${i+1}.</strong> ${escapeHtml(q.question)}</p>` +
          (Array.isArray(q.options) ? q.options.map(opt => `
              <label style="display:block; margin-bottom:6px;">
                <input type="radio" name="q${i}" value="${escapeAttr(opt)}"> ${escapeHtml(opt)}
              </label>
          `).join('') : '');
        form.appendChild(div);
      });
      $('#submitBtn').hidden = false;
      $('#quizForm').hidden = false;
    }

    function checkAnswers(){
      let score = 0;
      questions.forEach((q, i) => {
        const sel = document.querySelector(`input[name="q${i}"]:checked`);
        if (sel && sel.value.trim() === (q.answer || '').trim()) score++;
      });
      $('#result').textContent = `درجتك: ${score} من ${questions.length}`;
    }

    // ---- Add Question ----
    async function addQuestion(e){
      e.preventDefault();
      const addStatus = $('#addStatus');
      const qText = $('#qText').value.trim();
      const opts = Array.from(document.querySelectorAll('.option-input')).map(i => i.value.trim()).filter(Boolean);
      const qAnswer = $('#qAnswer').value.trim();

      if (!qText) { alert('أدخل نص السؤال'); return; }
      if (opts.length < 2) { alert('أدخل على الأقل خيارين'); return; }
      if (!opts.includes(qAnswer)) { alert('يجب أن تكون الإجابة الصحيحة إحدى الخيارات'); return; }

      addStatus.textContent = 'جاري الإرسال...';
      try {
        // use URLSearchParams to avoid preflight
        const payload = new URLSearchParams();
        payload.append('question', qText);
        payload.append('options', JSON.stringify(opts));
        payload.append('answer', qAnswer);

        const res = await fetch(API_URL, {
          method: 'POST',
          body: payload
        });

        const text = await res.text();
        // try parse if JSON
        try {
          const j = JSON.parse(text);
          if (j.ok === false) throw new Error(j.error || 'server error');
        } catch (err) {
          // if response is not JSON it's ok (Apps Script sometimes returns plain text)
        }

        addStatus.textContent = 'تمت إضافة السؤال!';
        document.getElementById('addForm').reset();
        // reset options to 4 empty ones
        optionsWrapper.innerHTML = '';
        addOption(''); addOption(''); addOption(''); addOption('');
        updateAnswerOptions();
        // reload questions
        loadQuestions();
      } catch (err) {
        console.error(err);
        addStatus.textContent = 'فشل في الإرسال.';
        alert('فشل في إرسال السؤال: ' + err.message);
      }
    }

    // small helper to escape html
    function escapeHtml(s){ return String(s || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function escapeAttr(s){ return String(s || '').replace(/"/g, '&quot;'); }

    // Start
    loadQuestions();
  </script>
</body>
</html>
